system:
  mode: 0
  distribute: False
  amp_level: 'O0'
  seed: 42
  val_while_train: True
  drop_overflow_update: True

model:
  type: det
  transform: null
  backbone:
    name: det_resnet50
    pretrained: True
  neck:
    name: DBFPN
    out_channels: 256
    bias: False
    use_asf: False # enable it for DB++ 
  head:
    name: DBHead
    k: 50
    bias: False
    adaptive: True

postprocess:
  name: DBPostprocess
  output_polygon: False   # whether to output a polygon or a box
  binary_thresh: 0.3      # binarization threshold
  box_thresh: 0.6         # box score threshold
  max_candidates: 1000
  expand_ratio: 1.5       # coefficient for expanding predictions

metric:
  name: DetMetric
  main_indicator: f-score

loss:
  name: L1BalancedCELoss
  eps: 1.0e-6
  l1_scale: 10
  bce_scale: 5
  bce_replace: bceloss

scheduler:
  scheduler: polynomial_decay
  min_lr: 0.
  lr: 0.007
  num_epochs: 2
  warmup_epochs: 1
  decay_epochs: 1

optimizer:
  opt: SGD
  filter_bias_and_bn: false
  momentum: 0.9
  weight_decay: 1.0e-4
  loss_scale: 1.0

train:
  ckpt_save_dir: './test_det_ckpt'
  dataset_sink_mode: False 
  dataset:
    type: DetDataset
    dataset_root: data/Canidae/
    data_dir: train/dogs
    label_file: train/det_gt.txt
    #data_dir: /Users/Samit/Data/datasets/ic15/det/train
    #label_file: /Users/Samit/Data/datasets/ic15/det/train/train_icdar2015_label.txt
    sample_ratio: [ 0.1 ]
    shuffle: True
    transform_pipeline:
      - DecodeImage:
          img_mode: BGR
          to_float32: False
      - DetLabelEncode:
      - MZResizeByGrid:
          divisor: 32
          transform_polys: True # originally in modelzoo, it doesn't transform polys
      - MZRandomScaleByShortSide:
          short_side: 736
      - IaaAugment:
          augmenter_args:
            - { 'type': 'Affine', 'args': { 'rotate': [ -10, 10 ] } }
            - { 'type': 'Fliplr', 'args': { 'p': 0.5 } }
      - MZRandomCropData:
          max_tries: 100
          min_crop_side_ratio: 0.1
          crop_size: [ 640, 640 ]
      - MZMakeSegDetectionData:
          min_text_size: 8
          shrink_ratio: 0.4
      - BorderMap:
          shrink_ratio: 0.4
          thresh_min: 0.3
          thresh_max: 0.7
      - MZRandomColorAdjust:
          brightness: 0.1255 #32.0 / 255
          saturation: 0.5
          to_numpy: True
      - NormalizeImage:
          bgr_to_rgb: True
          is_hwc: True
          mean: imagenet
          std: imagenet
      - ToCHWImage:
    #  the order of the dataloader list, matching the network input and the input labels for the loss function, and optional data for debug/visaulize 
    output_keys: ['image', 'binary_map', 'mask', 'thresh_map', 'thresh_mask'] #'img_path'] 
    #output_keys: ['image'] # for debug op performance
    num_keys_to_net: 1 # num inputs for network forward func in output_keys
#    keys_for_loss: 4 # num labels for loss func

  loader:
    shuffle: True # TODO: tbc
    batch_size: 2
    drop_remainder: False
    max_rowsize: 20
    num_workers: 1 # TODO: may lead to OOM

eval:
  ckpt_load_path: './test_det_ckpt/best.ckpt'
  dataset_sink_mode: False
  dataset:
    type: DetDataset
    dataset_root: data/Canidae/
    data_dir: val/dogs
    label_file: val/det_gt.txt
    sample_ratio: 0.1
    shuffle: False
    transform_pipeline:
      - DecodeImage:
          img_mode: BGR
          to_float32: False
      - DetLabelEncode:
      - MZScalePad:
          eval_size: [ 736, 1280 ] # h, w
      - NormalizeImage:
          bgr_to_rgb: True
          is_hwc: True
          mean: imagenet
          std: imagenet
      - ToCHWImage:
    #  the order of the dataloader list, matching the network input and the labels for evalution 
    output_keys: [ 'image', 'polys', 'ignore_tags' ] #'shape'] #'img_path']
    num_keys_to_net: 1 # num inputs for network forward func
    num_keys_of_labels: 2 # num labels 

  loader:
    shuffle: False
    batch_size: 1 # TODO: due to dynamic shape of polygons (num of boxes varies), BS has to be 1
    drop_remainder: False 
    max_rowsize: 20
    num_workers: 1
